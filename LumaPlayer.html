<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>LumaPlayer</title>
<style>
  :root{
    --bg:#0b0d10;
    --card:#0f1114;
    --muted:#9aa3ad;
    --accent:#4fc3f7;
    --light-bg:#f5f5f5;
    --light-card:#ffffff;
    --light-text:#111;
  }

  html,body{
    height:100%;
    margin:0;
    font-family:Inter,ui-sans-serif,system-ui,Segoe UI,Roboto,"Helvetica Neue",Arial;
  }

  body{
    background:var(--bg);
    color:#e6eef6;
    display:flex;
    align-items:center;
    justify-content:center;
    padding:18px;
    transition:0.3s;
  }

  body.light{
    background:var(--light-bg);
    color:var(--light-text);
  }

  .app{
    width:1180px;
    max-width:calc(100% - 36px);
    min-height:720px;
    background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
    border-radius:12px;
    padding:16px;
    box-shadow:0 8px 30px rgba(0,0,0,0.6);
    display:grid;
    grid-template-columns:1fr 380px;
    gap:14px;
    transition:0.3s;
  }

  body.light .app{
    background:var(--light-card);
    color:var(--light-text);
    box-shadow:0 8px 20px rgba(0,0,0,0.2);
  }

  .player-card{
    background:linear-gradient(180deg, rgba(255,255,255,0.01), transparent);
    border-radius:10px;
    padding:12px;
    display:flex;
    flex-direction:column;
    gap:10px;
    transition:0.3s;
  }

  body.light .player-card{
    background:var(--light-card);
  }

.viewer {
  width: 100%;
  height: 450px; /* fixed height (16:9-ish) */
  flex: none;
  background: #000;
  border-radius: 8px;
  display: flex;
  align-items: center;
  justify-content: center;
  position: relative;
  overflow: hidden;
  cursor: pointer;
}

  body.light .viewer{ background:#eee; }

video,img{
  max-width:100%;
  max-height:100%;
  width:auto;
  height:auto;
  object-fit:contain;
  background:#000;
  transition:0.3s;
  display:block;
}

  body.light video, body.light img{ background:#ddd; }

  .drop-hint{
    position:absolute;
    inset:12px;
    border-radius:8px;
    border:2px dashed rgba(255,255,255,0.06);
    display:flex;
    align-items:center;
    justify-content:center;
    pointer-events:none;
    color:var(--muted);
    font-size:14px;
    transition:0.3s;
  }

  .controls{
    display:flex;
    gap:8px;
    align-items:center;
    padding:8px;
  }

  .controls input[type=range]{ flex:1; }

  button{
    background:transparent;
    border:1px solid rgba(255,255,255,0.06);
    color:inherit;
    padding:8px 10px;
    border-radius:8px;
    cursor:pointer;
    transition:0.2s;
  }

  button.primary{
    background:linear-gradient(90deg,var(--accent),#6bdff8);
    color:#031018;
    border:none;
  }

  .sidebar{
    display:flex;
    flex-direction:column;
    gap:12px;
  }

  .files{
    background:linear-gradient(180deg,#071218, #061017);
    border-radius:10px;
    padding:10px;
    overflow:auto;
    max-height:360px;
    transition:0.3s;
  }

  body.light .files{ background:#f0f0f0; }

  .file-item{
    display:flex;
    gap:8px;
    align-items:center;
    padding:6px;
    border-radius:6px;
    cursor:pointer;
    transition:0.2s;
  }

  .file-item:hover{ background:rgba(255,255,255,0.02); }
  body.light .file-item:hover{ background:rgba(0,0,0,0.05); }

  .thumb{
    width:56px;
    height:40px;
    background:#081014;
    border-radius:6px;
    display:flex;
    align-items:center;
    justify-content:center;
    font-size:12px;
    color:var(--muted);
    overflow:hidden;
  }

  .meta{ flex:1; min-width:0; }
  .meta .name{ font-size:13px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
  .meta .sub{ font-size:12px; color:var(--muted); }
  .small{ font-size:12px; color:var(--muted); }
  input[type=file]{ display:none; }
  .topbar{ display:flex; gap:8px; align-items:center; }
  .toggles{ display:flex; gap:6px; flex-wrap:wrap; }
  .kbd{ background:rgba(255,255,255,0.03); padding:4px 8px; border-radius:6px; font-size:12px; }
  footer{ font-size:12px; color:var(--muted); text-align:center; margin-top:8px; }

  .dropdown{ position:relative; z-index:1000; }
  #dropdownMenu{
    display:none;
    position:absolute;
    background:#222;
    padding:6px;
    border-radius:6px;
    z-index:1001;
  }
  .dropdown-item{ padding:6px 12px; cursor:pointer; color:#fff; }
  .dropdown-item:hover{ background:rgba(255,255,255,0.1); }

  /* --- File details area --- */
  .file-details{
    background:rgba(255,255,255,0.03);
    padding:6px 10px;
    border-radius:6px;
    font-family: monospace;
    font-size:12px;
    transition:0.3s;
    min-height:20px;
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:10px;
  }
  body.light .file-details{
    background:rgba(0,0,0,0.05);
    color:var(--light-text);
  }

  /* --- Up next dock --- */
  .up-next{
    display:flex;
    gap:8px;
    align-items:center;
    padding:8px;
    border-radius:8px;
    background:rgba(255,255,255,0.02);
    color:var(--muted);
  }
  .up-next .item{ display:flex; gap:8px; align-items:center; padding:6px; border-radius:6px; min-width:0; }
  .up-next .item .name{ font-size:12px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }

  /* --- Visualizer --- */
  .visualizer-canvas{ position:absolute; left:8px; bottom:8px; width:320px; height:80px; border-radius:6px; background:transparent; pointer-events:none; opacity:0.9; }
  .thumbnail-preview{
    position:absolute;
    pointer-events:none;
    z-index:2000;
    width:160px;
    height:90px;
    border-radius:6px;
    overflow:hidden;
    display:none;
    box-shadow:0 6px 20px rgba(0,0,0,0.6);
    background:#000;
  }
  .thumbnail-preview canvas{ width:100%; height:100%; display:block; }

  /* --- Slideshow speed --- */
  .speed-control{ display:flex; gap:6px; align-items:center; }

  /* --- History modal --- */
  .modal{
    position:fixed;
    left:50%;
    top:50%;
    transform:translate(-50%,-50%);
    background:var(--card);
    padding:12px;
    border-radius:10px;
    max-width:min(700px,95%);
    max-height:80%;
    overflow:auto;
    box-shadow:0 12px 40px rgba(0,0,0,0.6);
    display:none;
    z-index:3000;
  }
  .modal h3{ margin:0 0 8px 0; font-size:16px; }
  .modal .row{ display:flex; gap:8px; padding:6px 0; align-items:center; border-bottom:1px solid rgba(255,255,255,0.02); }
  .modal .close{ position:absolute; right:8px; top:8px; cursor:pointer; }

  /* --- Cinema --- */
  body.cinema{ overflow:hidden; }
  body.cinema .app{ box-shadow:none; background:transparent; border-radius:0; }
  body.cinema::before{
    content:'';
    position:fixed;
    inset:0;
    background:rgba(0,0,0,0.75);
    z-index:999;
    pointer-events:none;
  }
 body.cinema .viewer {
  position: relative;
  z-index: 1000; /* higher than overlay */
 }
  /* --- Responsive tweaks --- */
  @media (max-width:1000px){
    .app{ grid-template-columns:1fr; }
    .sidebar{ order:2; }
  }
  
  
 /* --- Compact Mobile View (Incomplete As Of Current Version) --- */
@media (max-width: 600px) {
  body {
    padding: 8px;
  }

  .app {
    width: 100%;
    min-height: auto;
    grid-template-columns: 1fr;
    gap: 8px;
    padding: 8px;
    border-radius: 8px;
  }

  .player-card {
    padding: 8px;
  }

  .viewer {
    height: 220px; /* smaller for mobile */
  }

  .controls {
    flex-wrap: wrap;
    gap: 4px;
    padding: 4px;
  }

  .controls input[type=range] {
    flex: 1 1 100%;
    margin-top: 4px;
  }

  .toggles {
    flex-direction: column;
    gap: 4px;
  }

  .up-next {
    flex-direction: column;
    gap: 4px;
    font-size: 11px;
  }

  .sidebar {
    order: 2;
    width: 100%;
    max-height: 300px;
    overflow-y: auto;
    gap: 4px;
  }

  .files {
    max-height: 200px;
    font-size: 12px;
  }

  .file-item {
    gap: 4px;
    padding: 4px;
  }

  .thumb {
    width: 40px;
    height: 28px;
    font-size: 10px;
  }

  .file-details {
    font-size: 11px;
    padding: 4px 6px;
  }

  footer {
    font-size: 10px;
  }

  .topbar {
    flex-wrap: wrap;
    gap: 4px;
  }

  .topbar button,
  .topbar input[type=color],
  .dropdown button {
    padding: 4px 6px;
    font-size: 12px;
  }
}

.fullscreen-media {
  position: fixed !important;
  top: 0;
  left: 0;
  width: 100vw !important;
  height: 100vh !important;
  max-width: 100vw !important;
  max-height: 100vh !important;
  object-fit: contain !important;
  z-index: 10000;
  background: #000;
  cursor: none; /* hide cursor in fullscreen */
}

</style>
</head>
<body> 
<div class="app" role="application" aria-label="EnhancedView">
  <div class="player-card">
    <div class="topbar">
      <label class="kbd" id="modeLabel">Mode: Auto</label>
      <div style="flex:1"></div>
      <label class="kbd">Drag & Drop / Add files</label>
      <div class="dropdown">
        <button id="addFilesBtn">Add files ‚¨á</button>
        <div id="dropdownMenu">
          <div class="dropdown-item" id="uploadFiles">From Computer</div>
          <div class="dropdown-item" id="addUrl">From URL</div>
        </div>
      </div>
      <input id="fileInput" type="file" accept="*/*" multiple webkitdirectory directory />
      <button id="themeBtn">üåû</button>
      <button id="muteBtn">üîä</button>
	  
      <!-- Accent color picker -->
      <input id="accentPicker" type="color" title="Pick accent color" 
       style="width:36px;height:36px;border-radius:8px;border:none;margin-left:8px;"><button id="resetAccentBtn" title="Reset to rainbow accent" 
       style="margin-left:6px;padding:4px 8px;border:none;border-radius:6px;cursor:pointer;">üåà</button>
      <button id="cinemaBtn" title="Cinema mode">üé¨</button>
      <button id="historyBtn" title="Playback history">üìú</button>
    </div>

    <div class="viewer" id="viewer" title="Double-click to toggle fullscreen">
      <div class="drop-hint" id="dropHint">Drop files or folders here ‚Äî images & videos</div>

      <!-- primary media elements -->
      <video id="video" controls crossorigin playsinline style="display:none;"></video>
      <img id="image" alt="image viewer" style="display:none;" />

      <!-- visualizer canvas (for audio) -->
      <canvas id="visualizer" class="visualizer-canvas" width="640" height="160" style="display:none;"></canvas>

      <!-- thumbnail preview on seek hover -->
      <div class="thumbnail-preview" id="thumbPreview"><canvas id="thumbCanvas" width="320" height="180"></canvas></div>
    </div>

    <!-- Current File Details -->
    <div class="file-details" id="fileDetails">
      <div id="fileMeta">No file selected</div>
      <div style="display:flex;gap:8px;align-items:center">
	  	<input id="subtitleInput" type="file" accept=".srt,.vtt" style="display:none">
        <button id="addSubtitleBtn" title="Add subtitles">üí¨</button>
        <button id="screenshotBtn" title="Capture frame">üì∑</button>
        <button id="vizToggleBtn" title="Toggle visualizer">üìà</button>
      </div>
    </div>

    <div class="controls">
      <button id="prevBtn">‚èÆ</button>
      <button id="playBtn" class="primary">Play ‚ñ∂</button>
      <button id="nextBtn">‚è≠</button>
      <div class="small" id="time">00:00 / 00:00</div>
      <input id="seek" type="range" min="0" max="100" value="0">
      <input id="volume" type="range" min="0" max="1" step="0.01" value="0.8" style="width:120px">
      <select id="rate">
        <option value="0.5">0.5x</option>
        <option value="0.75">0.75x</option>
        <option value="1" selected>1x</option>
        <option value="1.25">1.25x</option>
        <option value="1.5">1.5x</option>
        <option value="2">2x</option>
      </select>
	  
      <button id="fsBtn">‚§¢</button>
      <button id="pipBtn">üì∫</button>
    </div>

    <div style="display:flex;gap:8px;align-items:center;justify-content:space-between">
      <div class="toggles">
        <label class="kbd"><input id="loopToggle" type="checkbox"> loop</label>
        <label class="kbd"><input id="slideshowToggle" type="checkbox"> slideshow (images & videos)</label>
        <label class="kbd"><input id="fitToggle" type="checkbox" checked> contain</label>
        <label class="kbd speed-control">speed <input id="slideshowSpeed" type="range" min="1" max="10" value="3" style="width:80px"> <span id="speedLabel">3s</span></label>
      </div>
      <div class="small">Keyboard: SPACE play, ‚Üê/‚Üí seek, ‚Üë/‚Üì vol, F fullscreen, N/P next/prev, M mute, C cinema</div>
    </div>

    <!-- up next dock -->
    <div class="up-next" id="upNextDock" title="Up next">
      <div style="font-weight:600;color:var(--muted);min-width:70px">Up next</div>
      <div id="upNextList" style="display:flex;gap:6px;flex:1"></div>
    </div>

    <footer>- Local-only player ‚Äî no external connections. Supports drag/drop and folder add.</footer>
    <footer>- URL Player - external connections when loaded but files are not saved to disk.</footer>
    <footer>If you have any questions or want to report a bug, email me at injectionmethod@proton.me or visit <a href="https://github.com/injectionmethod/LumaPlayer" target="_blank" rel="noopener noreferrer">LumaPlayer</a>.</footer>
	<footer>                                LumaPlayer Version: v1.a                                      </footer>
  </div>
  

  <div class="sidebar">
     <!-- playlist search -->
    <div style="margin-bottom:8px;">
    <input type="text" id="playlistSearch" placeholder="Search playlist..." style="width:100%;padding:4px 6px;border-radius:6px;border:0px solid #ccc;">
    </div>
    <div style="display:flex;align-items:center;justify-content:space-between">
      <div class="small">Playlist</div>
      <div class="small" id="stats">0 items</div>
    </div>
    <div class="files" id="playlist"></div>
    <div style="display:flex;gap:8px">
      <button id="clearBtn">Clear</button>
      <button id="shuffleBtn">Shuffle</button>
      <button id="exportBtn">Export list</button>
      <button id="saveSessionBtn" title="Save session to localStorage">üíæ</button>
    </div>
    <div style="margin-top:8px; display:flex;gap:8px;align-items:center;">
      <div class="small">History</div>
      <div style="flex:1"></div>
      <div class="small" id="historyCount">0</div>
    </div>
    <div style="margin-top:8px;">
      <button id="restoreSessionBtn">Restore session</button>
    </div>
  </div>
</div>

<!-- history modal -->
<div class="modal" id="historyModal" aria-hidden="true">
  <div class="close" id="closeHistory">‚úñ</div> 
  <h3>Playback History</h3>
      <button id="clearHistoryBtn" title="Clear playback history">üóëÔ∏è</button>
  <div id="historyList"></div>
</div>

<script>
(() => {

  // --- DOM elements ---
  const fileInput=document.getElementById('fileInput');
  const addFilesBtn=document.getElementById('addFilesBtn');
  const dropdownMenu=document.getElementById('dropdownMenu');
  const viewer=document.getElementById('viewer');
  const dropHint=document.getElementById('dropHint');
  const video=document.getElementById('video');
  const image=document.getElementById('image');
  const playBtn=document.getElementById('playBtn');
  const prevBtn=document.getElementById('prevBtn');
  const nextBtn=document.getElementById('nextBtn');
  const seek=document.getElementById('seek');
  const timeLabel=document.getElementById('time');
  const volume=document.getElementById('volume');
  const rate=document.getElementById('rate');
  const fsBtn=document.getElementById('fsBtn');
  const loopToggle=document.getElementById('loopToggle');
  const slideshowToggle=document.getElementById('slideshowToggle');
  const fitToggle=document.getElementById('fitToggle');
  const playlistEl=document.getElementById('playlist');
  const stats=document.getElementById('stats');
  const clearBtn=document.getElementById('clearBtn');
  const shuffleBtn=document.getElementById('shuffleBtn');
  const exportBtn=document.getElementById('exportBtn');
  const modeLabel=document.getElementById('modeLabel');
  const themeBtn=document.getElementById('themeBtn');
  const muteBtn=document.getElementById('muteBtn');
  const pipBtn=document.getElementById('pipBtn');
  const fileDetails=document.getElementById('fileDetails');
  const fileMeta=document.getElementById('fileMeta');
  const accentPicker=document.getElementById('accentPicker');
  const vizToggleBtn=document.getElementById('vizToggleBtn');
  const visualizerCanvas=document.getElementById('visualizer');
  const thumbPreview=document.getElementById('thumbPreview');
  const thumbCanvas=document.getElementById('thumbCanvas');
  const screenshotBtn=document.getElementById('screenshotBtn');
  const upNextList=document.getElementById('upNextList');
  const upNextDock=document.getElementById('upNextDock');
  const slideshowSpeed=document.getElementById('slideshowSpeed');
  const speedLabel=document.getElementById('speedLabel');
  const saveSessionBtn=document.getElementById('saveSessionBtn');
  const restoreSessionBtn=document.getElementById('restoreSessionBtn');
  const historyBtn=document.getElementById('historyBtn');
  const historyModal=document.getElementById('historyModal');
  const closeHistory=document.getElementById('closeHistory');
  const historyList=document.getElementById('historyList');
  const historyCount=document.getElementById('historyCount');
  const cinemaBtn=document.getElementById('cinemaBtn');

  // --- State variables ---
  let items=[]; // each item: {file?, url, name, type, size, remote:boolean, lastPos:number}
  let index=-1;
  let isPlaying=false;
  let slideshowTimer=null;
  let isMuted=false;
  let audioCtx=null;
  let analyser=null;
  let vizAnimation=null;
  let playedSet=new Set(); // for smart shuffle
  let slideshowInterval=3000;
  let history = JSON.parse(localStorage.getItem('player_history')||'[]'); // {name,url,date,position}
  const THUMB_W = 320, THUMB_H = 180;

  // --- LocalStorage: restore simple ---
  if(localStorage.getItem('accent')) document.documentElement.style.setProperty('--accent', localStorage.getItem('accent'));
  if(localStorage.getItem('theme')==='light') document.body.classList.add('light');
  themeBtn.textContent=document.body.classList.contains('light')?'üåô':'üåû';

  // load persisted toggles
  try {
    loopToggle.checked = localStorage.getItem('loopEnabled') === 'true';
    slideshowToggle.checked = localStorage.getItem('slideshowEnabled') === 'true';
    fitToggle.checked = localStorage.getItem('fitContain') !== 'false';
    slideshowSpeed.value = localStorage.getItem('slideshowSpeed') || slideshowSpeed.value;
  } catch(e){}

  speedLabel.textContent = slideshowSpeed.value + 's';
  slideshowInterval = Number(slideshowSpeed.value) * 1000;

  // --- helpers ---
  function isImage(type,name){
    if(type) return type.startsWith('image/');
    return /\.(jpe?g|png|gif|bmp|webp|svg|heic|heif|jfif)$/i.test(name);
  }
  function isVideo(type,name){
    if(type) return type.startsWith('video/');
    return /\.(mp4|m4v|webm|ogg|ogv|mov|qt|mkv|flv|avi|wmv|mpg)$/i.test(name);
  }
  function isAudio(type,name){
    if(type) return type.startsWith('audio/');
    return /\.(mp3|wav|m4a|aac|flac|ogg)$/i.test(name);
  }
  function formatBytes(n){
    if(!n||n===0) return '0 B';
    const sizes=['B','KB','MB','GB','TB'];
    const i=Math.floor(Math.log(n)/Math.log(1024));
    return (n/Math.pow(1024,i)).toFixed(i===0?0:1)+' '+sizes[i];
  }
  function formatTime(s){
    if(!s || isNaN(s) || !isFinite(s)) return '00:00';
    const m=Math.floor(s/60);
    const sec=Math.floor(s%60);
    return `${m.toString().padStart(2,'0')}:${sec.toString().padStart(2,'0')}`;
  }


//Clear History
const clearHistoryBtn = document.getElementById('clearHistoryBtn');

clearHistoryBtn.addEventListener('click', () => {
  if(confirm('Are you sure you want to clear all playback history?')) {
    history = [];
    localStorage.setItem('player_history', JSON.stringify(history));
    historyCount.textContent = '0';
    renderHistoryList();
  }
});

// Search Playlist
const playlistSearch = document.getElementById('playlistSearch');

playlistSearch.addEventListener('input', () => {
  const query = playlistSearch.value.toLowerCase();
  Array.from(playlistEl.children).forEach(el => {
    const i = Number(el.dataset.i);
    const item = items[i];
    if(item.name.toLowerCase().includes(query) || (item.fullName && item.fullName.toLowerCase().includes(query))) {
      el.style.display = 'flex';
    } else {
      el.style.display = 'none';
    }
  });
});


// Shorten File Names
function shortenFileName(name, maxLen = 28) {
  if (name.length <= maxLen) return name;
  const lastDot = name.lastIndexOf('.');
  if (lastDot === -1 || lastDot === 0) {
    return name.slice(0, maxLen - 3) + '..';
  }
  const ext = name.slice(lastDot);
  const base = name.slice(0, maxLen - 3 - ext.length);
  return base + '...' + ext;
}

  // --- Add files ---
  function addFiles(fileList,opts={fromDrop:false}){
    const arr = Array.from(fileList || []);
    arr.forEach(f=>{
      if(f.size===0 && !f.type && f.name.endsWith('/')) return;
      const url = URL.createObjectURL(f);
      const shortName = shortenFileName(f.name);
items.push({file:f, url, name: shortName, fullName: f.name, type: f.type || '', size: f.size, remote:false, lastPos:0});
    });
    rebuildPlaylist();
    if(index===-1 && items.length) playIndex(0);
  }

  function addUrlEntry(url){
    const originalName = url.split('/').pop() || url;
const shortName = shortenFileName(originalName);
    const type = isImage(null,url)?'image':isVideo(null,url)?'video':isAudio(null,url)?'audio':'unknown';
    items.push({file:null, url, name: shortName, fullName: originalName, type, size:0, remote:true, lastPos:0});
    rebuildPlaylist();
    if(index===-1) playIndex(items.length-1);
  }

  function stopVideoPlayback(){
    try { video.pause(); video.currentTime = 0; } catch(e){}
    video.removeAttribute('src');
    video.load();
  }

  // --- Rebuild playlist ---
function rebuildPlaylist(){
  playlistEl.innerHTML = '';
  items.forEach((it, i) => {
    const el = document.createElement('div');
    el.className = 'file-item';
    el.dataset.i = i;

    const thumb = document.createElement('div');
    thumb.className = 'thumb';
    thumb.textContent = isImage(it.type, it.name) ? 'IMG' : isVideo(it.type, it.name) ? 'VID' : isAudio(it.type, it.name) ? 'AUD' : 'FILE';

    const meta = document.createElement('div');
    meta.className = 'meta';
    const name = document.createElement('div'); 
    name.className = 'name'; 
    name.textContent = it.name;
    name.title = it.fullName || it.name;
    const sub = document.createElement('div'); 
    sub.className = 'sub'; 
    sub.textContent = (it.size ? formatBytes(it.size) : '') + (it.type ? (' ‚Ä¢ ' + it.type) : '') + (it.remote ? ' ‚Ä¢ URL' : '');
    meta.appendChild(name); 
    meta.appendChild(sub);

    // Remove button
    const removeBtn = document.createElement('button');
    removeBtn.textContent = '‚úñ';
    removeBtn.title = 'Remove from playlist';
    removeBtn.style.marginLeft = '6px';
    removeBtn.addEventListener('click', (e) => {
      e.stopPropagation();
      if(it.url && it.file) URL.revokeObjectURL(it.url);
      items.splice(i, 1);
      if(index >= items.length) index = items.length - 1;
      rebuildPlaylist();
      if(items.length && index >= 0) playIndex(index);
      else {
        video.src = '';
        image.src = '';
        fileMeta.textContent = 'No file selected';
        timeLabel.textContent = '00:00 / 00:00';
      }
    });

    el.appendChild(thumb);
    el.appendChild(meta);
    el.appendChild(removeBtn);

    el.addEventListener('click', () => playIndex(Number(el.dataset.i)));

    playlistEl.appendChild(el);
  });

  stats.textContent = items.length + ' items';
  dropHint.style.display = items.length ? 'none' : 'flex';
  updateUpNext();
}


  // --- Update file details / metadata viewer ---
  function updateFileDetails(file){
    if(!file){ fileMeta.textContent='No file selected'; return; }
    const name = file.name || 'Unknown';
    const type = file.type || file.type || 'Unknown';
    const size = file.size?formatBytes(file.size): (file.remote? 'remote' : 'N/A');

    if(isImage(file.type,file.name || file.name)){
      const img = new Image();
      img.crossOrigin = 'anonymous';
      img.src = file.url;
      img.onload = ()=>{
        fileMeta.textContent = `${name} ‚Ä¢ ${type} ‚Ä¢ ${size} ‚Ä¢ ${img.width}x${img.height}px`;
        // attempt to read basic EXIF
        if(file.file && file.file instanceof File){
          readEXIFOrientation(file.file).then(o=>{
            if(o) fileMeta.textContent += ` ‚Ä¢ EXIF orient:${o}`;
          }).catch(()=>{});
        }
      };
      img.onerror = ()=>{ fileMeta.textContent = `${name} ‚Ä¢ ${type} ‚Ä¢ ${size}`; };
    } else if(isVideo(file.type,file.name || file.name)){
      const vid = document.createElement('video');
      vid.preload='metadata';
      vid.src = file.url;
      vid.onloadedmetadata = ()=>{
        const duration = formatTime(vid.duration);
        fileMeta.textContent = `${name} ‚Ä¢ ${type} ‚Ä¢ ${size} ‚Ä¢ ${vid.videoWidth}x${vid.videoHeight}px ‚Ä¢ ${duration}`;
      };
      vid.onerror = ()=>{ fileMeta.textContent = `${name} ‚Ä¢ ${type} ‚Ä¢ ${size}`; };
    } else if(isAudio(file.type,file.name)){
      fileMeta.textContent = `${name} ‚Ä¢ ${type} ‚Ä¢ ${size} ‚Ä¢ audio`;
    } else {
      fileMeta.textContent = `${name} ‚Ä¢ ${type} ‚Ä¢ ${size}`;
    }
  }

  // --- Play index ---
  function playIndex(i,opts={fromUser:true}){
    if(i<0||i>=items.length) return;
    index=i;
    const it = items[index];

    updateFileDetails(it); // show file details
    modeLabel.textContent = 'Mode: ' + (isImage(it.type,it.name)?'Image':(isVideo(it.type,it.name)?'Video':(isAudio(it.type,it.name)?'Audio':'Unknown')));
    stopSlideshow();

    // clear visualizer
    hideVisualizer();

    if(isImage(it.type,it.name)){
      video.style.display='none';
      image.style.display='block';
      image.src = it.url;
      playBtn.textContent='View';
      timeLabel.textContent = it.name;
      seek.value = 0;
      seek.disabled = true;
      stopVideoPlayback();
      if(slideshowToggle.checked) startSlideshow();
    } else if(isVideo(it.type,it.name)){
      image.style.display='none';
      video.style.display='block';
      video.src = it.url;
      video.load();
      // try to restore last position
      if(typeof it.lastPos === 'number' && it.lastPos > 0){
        video.addEventListener('loadedmetadata', function rescue() {
          try {
            if(!isNaN(video.duration) && it.lastPos < video.duration - 1){
              video.currentTime = it.lastPos;
            }
          } catch(e){}
          video.removeEventListener('loadedmetadata', rescue);
        });
      }
      if(slideshowToggle.checked || isPlaying) video.play();
      playBtn.textContent = (isPlaying||slideshowToggle.checked)?'Pause ‚ñÆ‚ñÆ':'Play ‚ñ∂';
      seek.disabled = false;
    } else if(isAudio(it.type,it.name)){
      image.style.display='none';
      video.style.display='block';
      video.src = it.url;
      video.load();
      video.controls = true;
      // audio visualizer auto display
      showVisualizer();
      if(slideshowToggle.checked || isPlaying) video.play();
      playBtn.textContent = (isPlaying||slideshowToggle.checked)?'Pause ‚ñÆ‚ñÆ':'Play ‚ñ∂';
      seek.disabled = false;
    } else {
      image.style.display='none';
      video.style.display='none';
      playBtn.textContent='Play ‚ñ∂';
      timeLabel.textContent = it.name;
      seek.disabled=true;
    }

    // highlight current
    Array.from(playlistEl.children).forEach((c,ci)=>c.style.background=ci===index?'rgba(255,255,255,0.02)':'');
    updateUpNext();
    recordHistory(it);
  }

  // --- Controls ---
  playBtn.addEventListener('click',()=>{
    if(index===-1) return;
    const it = items[index];
    if(isImage(it.type,it.name)){ next(); return; }
    if(video.paused){ video.play(); isPlaying=true; playBtn.textContent='Pause ‚ñÆ‚ñÆ'; }
    else{ video.pause(); isPlaying=false; playBtn.textContent='Play ‚ñ∂'; }
  });

  prevBtn.addEventListener('click',prev);
  nextBtn.addEventListener('click',next);
  function prev(){ if(items.length===0) return; let i=index-1; if(i<0)i=items.length-1; playIndex(i); }
  function next(fromAuto=false){
    if(items.length===0) return;
    if(shuffleBtn.dataset.on === 'true'){
      if(playedSet.size >= items.length) playedSet.clear();
      let candidates = items.map((it,idx)=>idx).filter(idx => !playedSet.has(idx));
      if(candidates.length === 0) candidates = items.map((it,idx)=>idx);
      let pick = candidates[Math.floor(Math.random()*candidates.length)];
      playedSet.add(pick);
      playIndex(pick);
    } else {
      let i=index+1; if(i>=items.length)i=0; playIndex(i);
    }
  }

  video.addEventListener('timeupdate',()=>{
    if(video.duration && !isNaN(video.duration)){
      seek.value=(video.currentTime/video.duration)*100;
      timeLabel.textContent = formatTime(video.currentTime)+' / '+formatTime(video.duration);
    }
  });

  video.addEventListener('ended',()=>{
    // save lastPos
    if(index>=0 && items[index]) items[index].lastPos = 0;
    if(loopToggle.checked) { video.currentTime=0; video.play(); }
    else if(slideshowToggle.checked) next(true);
    else next(true);
  });

  seek.addEventListener('input',()=>{
    if(video.duration && !isNaN(video.duration)) video.currentTime=(seek.value/100)*video.duration;
  });

  volume.addEventListener('input',()=>{
    video.volume=Number(volume.value);
    if(video.volume>0) isMuted=false;
    updateMuteBtn();
  });

  rate.addEventListener('change',()=>{ video.playbackRate=Number(rate.value); });

  // --- Slideshow ---
  function startSlideshow(){
    stopSlideshow();
    if(index===-1) return;
    const cur = items[index];
    if(isImage(cur.type,cur.name)) slideshowTimer = setInterval(()=>next(true), slideshowInterval);
    else { video.play(); video.onended = ()=>{ if(slideshowToggle.checked) next(true); }; }
  }
  function stopSlideshow(){ if(slideshowTimer){ clearInterval(slideshowTimer); slideshowTimer=null; } if(video) video.onended=null; }

  slideshowToggle.addEventListener('change',()=>{
    localStorage.setItem('slideshowEnabled', slideshowToggle.checked);
    if(slideshowToggle.checked) startSlideshow(); else stopSlideshow();
  });

  slideshowSpeed.addEventListener('input',()=>{
    speedLabel.textContent = slideshowSpeed.value+'s';
    slideshowInterval = Number(slideshowSpeed.value) * 1000;
    localStorage.setItem('slideshowSpeed', slideshowSpeed.value);
    if(slideshowToggle.checked) startSlideshow();
  });

  // --- Fit toggle ---
  fitToggle.addEventListener('change',()=>{
    const v=fitToggle.checked?'contain':'cover'; video.style.objectFit=v; image.style.objectFit=v;
    localStorage.setItem('fitContain', fitToggle.checked);
  });

  // --- Fullscreen ---
  fsBtn.addEventListener('click',()=>toggleFS(viewer));
  viewer.addEventListener('dblclick',()=>toggleFS(viewer));
  
  function toggleFS(el) {
  if (!document.fullscreenElement) {
    el.requestFullscreen?.();
    el.removeAttribute('title');
    video.classList.add('fullscreen-media');
    image.classList.add('fullscreen-media');
  } else {
    document.exitFullscreen?.();
    video.classList.remove('fullscreen-media');
    image.classList.remove('fullscreen-media');
    el.setAttribute('title', 'Double-click to toggle fullscreen');
  }
}


document.addEventListener('fullscreenchange', () => {
  fsBtn.textContent = document.fullscreenElement ? '‚§°' : '‚§¢';

  if(!document.fullscreenElement){
    video.classList.remove('fullscreen-media');
    image.classList.remove('fullscreen-media');
  }
});

  document.addEventListener('fullscreenchange',()=>{ fsBtn.textContent=document.fullscreenElement?'‚§°':'‚§¢'; });

  // --- PiP ---
  pipBtn.addEventListener('click',async()=>{ try{ if(document.pictureInPictureElement) await document.exitPictureInPicture(); else if(!video.paused) await video.requestPictureInPicture(); }catch(e){ console.warn(e); } });

  // --- Theme ---
  themeBtn.addEventListener('click',()=>{ document.body.classList.toggle('light'); themeBtn.textContent=document.body.classList.contains('light')?'üåô':'üåû'; localStorage.setItem('theme', document.body.classList.contains('light')?'light':'dark'); });

  // --- Mute ---
  function updateMuteBtn(){ muteBtn.textContent=isMuted?'üîá':'üîä'; video.muted=isMuted; }
  muteBtn.addEventListener('click',()=>{ isMuted=!isMuted; updateMuteBtn(); });

  // --- Dropdown ---
  addFilesBtn.addEventListener('click',()=>{ dropdownMenu.style.display=dropdownMenu.style.display==='block'?'none':'block'; });
  document.getElementById('uploadFiles').addEventListener('click',()=>{ fileInput.click(); dropdownMenu.style.display='none'; });
  document.getElementById('addUrl').addEventListener('click',()=>{
    const url=prompt('Enter media URL:'); if(url){ addUrlEntry(url); }
    dropdownMenu.style.display='none';
  });

  // --- Drag & drop files & URLs ---
  ['dragenter','dragover'].forEach(e=>document.addEventListener(e,ev=>{ ev.preventDefault(); dropHint.style.opacity=1; }));
  ['dragleave','drop'].forEach(e=>document.addEventListener(e,ev=>{ ev.preventDefault(); dropHint.style.opacity=0.001; }));
  document.addEventListener('drop',ev=>{
    const dt=ev.dataTransfer; if(!dt) return;
    if(dt.files && dt.files.length) addFiles(dt.files);
    const text=dt.getData('text').trim();
    if(text){ addUrlEntry(text); }
  });

  fileInput.addEventListener('change',e=>addFiles(e.target.files));

  // --- Keyboard ---
 document.addEventListener('keydown', e => {
  if(document.activeElement === playlistSearch) return;

  if(e.code==='Space'){ e.preventDefault(); playBtn.click(); }
  if(e.code==='ArrowRight'){ if(video) video.currentTime+=5; }
  if(e.code==='ArrowLeft'){ if(video) video.currentTime-=5; }
  if(e.code==='ArrowUp'){ volume.value=Math.min(1,Number(volume.value)+0.05); volume.dispatchEvent(new Event('input')); }
  if(e.code==='ArrowDown'){ volume.value=Math.max(0,Number(volume.value)-0.05); volume.dispatchEvent(new Event('input')); }
  if(e.key==='f'){ fsBtn.click(); }
  if(e.key==='n'){ next(); }
  if(e.key==='p'){ prev(); }
  if(e.key.toLowerCase()==='m'){ isMuted=!isMuted; updateMuteBtn(); }
  if(e.key.toLowerCase()==='l'){ themeBtn.click(); }
  if(e.key.toLowerCase()==='c'){ cinemaBtn.click(); }
});

  // --- Playlist operations ---
  clearBtn.addEventListener('click',()=>{
    items.forEach(it=>{ if(it.url && it.file) URL.revokeObjectURL(it.url); });
    items=[]; index=-1; rebuildPlaylist();
    video.src=''; image.src=''; timeLabel.textContent='00:00 / 00:00';
    fileMeta.textContent='No file selected';
    playedSet.clear();
  });

  shuffleBtn.addEventListener('click',()=>{
    if(shuffleBtn.dataset.on === 'true'){ // turn off
      shuffleBtn.dataset.on = 'false'; shuffleBtn.textContent='Shuffle';
    } else {
      shuffleBtn.dataset.on = 'true'; shuffleBtn.textContent='Shuffle ‚úì';
      playedSet.clear();
      if(index>=0) playedSet.add(index);
    }
  });

  exportBtn.addEventListener('click',()=>{
    const list=items.map(it=>it.url||it.name).join('\n');
    const blob=new Blob([list],{type:'text/plain'});
    const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='playlist.txt'; a.click(); URL.revokeObjectURL(a.href);
  });

  // --- Codec error handling ---
  video.addEventListener('error',()=>{ timeLabel.textContent='Playback error: unsupported codec'; });

  // --- Cleanup on unload ---
  window.addEventListener('beforeunload',()=>{
    // Save session
    try {
      const save = { items: items.filter(it=>it.remote).map(it=>({url:it.url,name:it.name,type:it.type,lastPos:it.lastPos||0})), index, currentTime: video.currentTime || 0 };
      localStorage.setItem('player_saved_session', JSON.stringify(save));
      localStorage.setItem('player_history', JSON.stringify(history.slice(-200))); // keep last 200
      items.forEach(it=>{ if(it.url && it.file) URL.revokeObjectURL(it.url); });
    } catch(e){}
  });

  // --- Update play/pause ---
  video.addEventListener('play',()=>{ isPlaying=true; playBtn.textContent='Pause ‚ñÆ‚ñÆ'; });
  video.addEventListener('pause',()=>{ isPlaying=false; playBtn.textContent='Play ‚ñ∂'; });

  fitToggle.dispatchEvent(new Event('change'));

  // --- Accent picker ---
  const accentSaved = localStorage.getItem('accent') || getComputedStyle(document.documentElement).getPropertyValue('--accent').trim();
  accentPicker.value = rgbToHex(accentSaved) || '#4fc3f7';
  accentPicker.addEventListener('input', e=>{
    document.documentElement.style.setProperty('--accent', e.target.value);
    localStorage.setItem('accent', e.target.value);
  });

  // --- Thumbnail preview (Under Construction) ---
  const thumbCtx = thumbCanvas.getContext('2d');
  const seekRectCache = { left:0, width:0 };
  seek.addEventListener('mousemove', async (ev) => {
    if(index===-1) return;
    const it = items[index];

    if(!isVideo(it.type,it.name)) return;
    if(!seekRectCache.width){
      const r = seek.getBoundingClientRect(); seekRectCache.left = r.left; seekRectCache.width = r.width;
    }
    const ratio = (ev.clientX - seekRectCache.left) / seekRectCache.width;
    if(ratio < 0 || ratio > 1) { thumbPreview.style.display='none'; return; }
    const previewTime = (video.duration || 0) * ratio;

    const x = ev.clientX - 80;
    thumbPreview.style.left = Math.max(8, Math.min(window.innerWidth - THUMB_W - 8, x)) + 'px';
    thumbPreview.style.top = (viewer.getBoundingClientRect().top - THUMB_H - 12) + 'px';
    thumbPreview.style.display='block';
    try {
      // offscreen video to seek
      await drawVideoFrameAtTime(it.url, previewTime, thumbCtx);
    } catch(e){
      // CORS fallback
      thumbPreview.style.display='none';
    }
  });
  seek.addEventListener('mouseleave', ()=>{ thumbPreview.style.display='none'; });

  // frame from url helper
  async function drawVideoFrameAtTime(url, t, ctx){
    return new Promise((resolve,reject)=>{
      const v = document.createElement('video');
      v.crossOrigin = 'anonymous';
      v.muted = true;
      v.playsInline = true;
      v.src = url;
      v.currentTime = Math.max(0, t);
      v.preload = 'auto';
      // attempt to play briefly
      v.addEventListener('loadeddata', function loaded(){
        // clamp
        if(v.duration && t > v.duration) t = Math.max(0, v.duration - 0.1);
        v.currentTime = t;
      });
      v.addEventListener('seeked', function onseek(){
        try {
          ctx.clearRect(0,0,THUMB_W,THUMB_H);
          ctx.drawImage(v, 0,0, THUMB_W, THUMB_H);
        } catch(e){ v.remove(); reject(e); return; }
        v.remove();
        resolve();
      });
      v.addEventListener('error', (e)=>{ v.remove(); reject(e); });
      setTimeout(()=>{ try{ v.remove(); reject(new Error('timeout')); }catch(e){} }, 1500);
    });
  }

  // --- Visualizer ---
  const vizCtx = visualizerCanvas.getContext('2d');
  vizCtx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--accent') + 'CC';
  function showVisualizer() {
    if (visualizerCanvas.style.display === 'block') return;
    visualizerCanvas.style.display = 'block';
    try {
      if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      if (!analyser) {
        analyser = audioCtx.createAnalyser();
        analyser.fftSize = 256;
      }
      const src = audioCtx.createMediaElementSource(video);
      src.connect(analyser);
      analyser.connect(audioCtx.destination);
      renderVisualizer();
    } catch (e) {
      console.warn('Visualizer initialization failed:', e);
    }
  }
  function hideVisualizer(){
    if(visualizerCanvas.style.display === 'none') return;
    visualizerCanvas.style.display = 'none';
    if(vizAnimation) cancelAnimationFrame(vizAnimation);
    vizAnimation = null;
  }
  function renderVisualizer(){
    const bufferLength = analyser.frequencyBinCount;
    const data = new Uint8Array(bufferLength);
    const w = visualizerCanvas.clientWidth;
    const h = visualizerCanvas.clientHeight;
    function draw(){
      vizAnimation = requestAnimationFrame(draw);
      analyser.getByteFrequencyData(data);
      vizCtx.clearRect(0,0, visualizerCanvas.width, visualizerCanvas.height);
      visualizerCanvas.width = Math.floor(visualizerCanvas.clientWidth * devicePixelRatio);
      visualizerCanvas.height = Math.floor(visualizerCanvas.clientHeight * devicePixelRatio);
      const cw = visualizerCanvas.width, ch = visualizerCanvas.height;
      const barWidth = cw / bufferLength;
      for(let i=0;i<bufferLength;i++){
        const v = data[i] / 255;
        const y = v * ch;
        vizCtx.fillStyle = 'rgba(79,195,247,0.9)';
        vizCtx.fillRect(i*barWidth, ch - y, barWidth*0.9, y);
      }
    }
    draw();
  }

  vizToggleBtn.addEventListener('click', ()=>{
    if(visualizerCanvas.style.display === 'block') hideVisualizer();
    else showVisualizer();
  });

  // --- Screenshot capture ---
  screenshotBtn.addEventListener('click', ()=>{
    if(index === -1) return;
    const it = items[index];
    if(isImage(it.type,it.name)){
      fetch(it.url).then(r=>r.blob()).then(b=>{
        const a=document.createElement('a');
        a.href = URL.createObjectURL(b);
        a.download = (it.name || 'image') + '.png';
        a.click();
        URL.revokeObjectURL(a.href);
      }).catch(()=>alert('Unable to fetch image for download (CORS)'));
    } else if(isVideo(it.type,it.name) || isAudio(it.type,it.name)){
      const c = document.createElement('canvas');
      const w = video.videoWidth || 1280;
      const h = video.videoHeight || 720;
      c.width = w;
      c.height = h;
      const ctx = c.getContext('2d');
      try {
        ctx.drawImage(video, 0,0, w, h);
        c.toBlob((blob)=>{
          const a=document.createElement('a');
          a.href = URL.createObjectURL(blob);
          a.download = (it.name || 'frame') + '.png';
          a.click();
          URL.revokeObjectURL(a.href);
        }, 'image/png');
      } catch(e){
        alert('Unable to capture screenshot (possibly CORS)');
      }
    } else {
      alert('Nothing to capture');
    }
  });

  // --- Up next dock ---
  function updateUpNext(){
    upNextList.innerHTML = '';
    if(index === -1) return;
    for(let i=1;i<=3;i++){
      const idx = (index + i) % Math.max(1, items.length);
      const it = items[idx];
      if(!it) continue;
      const el = document.createElement('div');
      el.className = 'item';
      el.style.flex = '1';
      el.innerHTML = `<div style="width:48px;height:34px;background:#071017;border-radius:6px;display:flex;align-items:center;justify-content:center">${isImage(it.type,it.name)?'IMG':isVideo(it.type,it.name)?'VID':isAudio(it.type,it.name)?'AUD':'FILE'}</div>
                      <div style="min-width:0"><div class="name">${it.name}</div><div class="small" style="color:var(--muted)">${it.remote?'URL':''}</div></div>`;
      el.addEventListener('click', ()=>playIndex(idx));
      upNextList.appendChild(el);
    }
  }

  // --- Session restore/save ---
  saveSessionBtn.addEventListener('click', ()=>{
    try {
      const save = { items: items.filter(it=>it.remote).map(it=>({url:it.url,name:it.name,type:it.type,lastPos:it.lastPos||0})), index, currentTime: video.currentTime || 0, timestamp: Date.now() };
      localStorage.setItem('player_saved_session', JSON.stringify(save));
      alert('Session saved (remote URLs only).');
    } catch(e){ alert('Failed to save session'); }
  });

  restoreSessionBtn.addEventListener('click', ()=>{
    const raw = localStorage.getItem('player_saved_session');
    if(!raw){ alert('No saved session found'); return; }
    try {
      const save = JSON.parse(raw);
      // replace playlist with remote items
      items = save.items.map(it=>({file:null,url:it.url,name:it.name,type:it.type,size:0,remote:true,lastPos:it.lastPos||0}));
      rebuildPlaylist();
      if(typeof save.index === 'number') playIndex(save.index);
      if(typeof save.currentTime === 'number' && video.src){ video.currentTime = save.currentTime; }
      alert('Session restored (remote items). Local files cannot be restored due to security.');
    } catch(e){ alert('Failed to restore session'); }
  });

  // --- History handler ---
  function recordHistory(it){
    try {
      history = history || [];
      const entry = { name: it.name, url: it.url, type: it.type, date: Date.now(), lastPos: it.lastPos || (video && !video.paused ? video.currentTime || 0 : 0) };
      history.push(entry);
      if(history.length > 500) history.shift();
      localStorage.setItem('player_history', JSON.stringify(history));
      historyCount.textContent = history.length;
    } catch(e){}
  }

  historyBtn.addEventListener('click', ()=>{
    historyModal.style.display = 'block'; historyModal.setAttribute('aria-hidden','false');
    renderHistoryList();
  });

  closeHistory.addEventListener('click', ()=>{ historyModal.style.display = 'none'; historyModal.setAttribute('aria-hidden','true'); });

  function renderHistoryList(){
    historyList.innerHTML = '';
    if(!history || !history.length) { historyList.textContent = 'No history'; return; }
    history.slice().reverse().forEach((h,idx)=>{
      const row = document.createElement('div'); row.className='row';
      row.innerHTML = `<div style="flex:1"><div style="font-weight:600">${h.name}</div><div class="small">${new Date(h.date).toLocaleString()} ‚Ä¢ ${h.type || ''}</div></div>
                       <div style="display:flex;gap:8px;align-items:center"><button class="replay">‚ñ∂</button><button class="remove">‚úñ</button></div>`;
      row.querySelector('.replay').addEventListener('click', ()=>{ addUrlEntry(h.url); historyModal.style.display='none'; });
      row.querySelector('.remove').addEventListener('click', ()=>{ history = history.filter(x=>x !== h); localStorage.setItem('player_history', JSON.stringify(history)); renderHistoryList(); });
      historyList.appendChild(row);
    });
  }


  // --- EXIF reader (basic) ---
  async function readEXIFOrientation(file){
    return new Promise((resolve,reject)=>{
      const reader = new FileReader();
      reader.onload = function(e){
        try{
          const view = new DataView(e.target.result);
          if(view.getUint16(0, false) != 0xFFD8) return resolve(null);
          let offset = 2, length = view.byteLength;
          while(offset < length){
            const marker = view.getUint16(offset, false);
            offset += 2;
            if(marker == 0xFFE1){
              const little = view.getUint16(offset + 8, false) === 0x4949;
              const exifOffset = offset + 10;
              const tags = view.getUint16(exifOffset + (little ? 4 : 6), little);
              // attempt to find orientation tag (0x0112)
              for(let i=0;i<tags;i++){
                const tagOffset = exifOffset + (little ? 8 : 10) + i*12;
                const tag = view.getUint16(tagOffset, little);
                if(tag === 0x0112){
                  const orient = view.getUint16(tagOffset + (little ? 8 : 10), little);
                  return resolve(orient);
                }
              }
            } else if((marker & 0xFF00) != 0xFF00) break;
            else offset += view.getUint16(offset, false);
          }
          resolve(null);
        }catch(err){ resolve(null); }
      };
      reader.onerror = ()=>resolve(null);
      reader.readAsArrayBuffer(file.slice(0, 128 * 1024));
    });
  }

  // --- rgb to hex fallback ---
  function rgbToHex(rgb){
    if(!rgb) return null;
    rgb = rgb.trim();
    if(rgb.startsWith('#')) return rgb;
    const m = rgb.match(/rgba?\((\d+),\s*(\d+),\s*(\d+)/);
    if(!m) return null;
    return '#' + [1,2,3].map(i=>parseInt(m[i]).toString(16).padStart(2,'0')).join('');
  }


  // --- Save current playback position for remote media ---
  setInterval(()=>{
    if(index>=0 && items[index]){
      const it = items[index];
      if(video && !video.paused && (isVideo(it.type,it.name) || isAudio(it.type,it.name))){
        it.lastPos = video.currentTime;
      }
    }
  }, 2000);

  // --- restore saved session if any (auto) ---
  (function tryAutoRestore(){
    const raw = localStorage.getItem('player_saved_session');
    if(!raw) return;
    try {
      const save = JSON.parse(raw);
      // only restore if user hasn't added any local files in this session
      if(items.length === 0 && save.items && save.items.length){
        items = save.items.map(it=>({file:null,url:it.url,name:it.name,type:it.type,size:0,remote:true,lastPos:it.lastPos||0}));
        rebuildPlaylist();
        if(typeof save.index === 'number') playIndex(save.index);
        if(typeof save.currentTime === 'number') video.currentTime = save.currentTime;
      }
    } catch(e){}
  })();

  // --- show history count on load ---
  historyCount.textContent = (history && history.length) ? history.length : 0;

  // --- Cinema mode toggle ---
  cinemaBtn.addEventListener('click', ()=>{
    document.body.classList.toggle('cinema');
  });

  // --- Expose a small debug function in window ---
  window.__player = {
    items,
    playIndex,
    next,
    prev,
    rebuildPlaylist
  };
  
  // Subtitle Handler
  const subtitleInput = document.getElementById('subtitleInput');
const addSubtitleBtn = document.getElementById('addSubtitleBtn');

addSubtitleBtn.addEventListener('click', () => subtitleInput.click());

subtitleInput.addEventListener('change', async (e) => {
  const file = e.target.files[0];
  if (!file) return;

  const text = await file.text();
  const vttText = file.name.endsWith('.srt') ? srtToVtt(text) : text;

  // Remove old tracks
  Array.from(video.querySelectorAll('track')).forEach(t => t.remove());

  // Create new track
  const track = document.createElement('track');
  track.kind = 'subtitles';
  track.label = file.name;
  track.srclang = 'en';
  track.default = true; // mark as default

  // Blob URL for subtitles
  const blob = new Blob([vttText], { type: 'text/vtt' });
  track.src = URL.createObjectURL(blob);

  video.appendChild(track);

  // Wait for the track to load before showing it
  track.addEventListener('load', () => {
    track.mode = 'showing'; // now it will display
  });
});

function srtToVtt(data) {
  // Add WebVTT header
  let vtt = 'WEBVTT\n\n';
  // Replace SRT time format "00:00:01,500" ‚Üí "00:00:01.500"
  vtt += data
    .replace(/\r+/g, '')
    .replace(/^\d+\s*$/gm, '') // remove SRT index numbers
    .replace(/(\d{2}:\d{2}:\d{2}),(\d{3})/g, '$1.$2'); // comma to dot
  return vtt;
}

// Default Rainbow
let __rainbowInterval = null;
let __rainHue = 0;
const __root = document.documentElement;


function __startRainbowAccent() {
  if (__rainbowInterval) return;
  __rainbowInterval = setInterval(() => {
    __rainHue = (__rainHue + 1) % 360;
    const color = `hsl(${__rainHue}, 80%, 55%)`;
    __root.style.setProperty('--accent', color);
  }, 50);
}

function __stopRainbowAccent() {
  if (__rainbowInterval) {
    clearInterval(__rainbowInterval);
    __rainbowInterval = null;
  }
}

accentPicker.addEventListener('input', (e) => {
  try {
    const color = e.target.value;
    localStorage.setItem('accent', color);
    __root.style.setProperty('--accent', color);
    __stopRainbowAccent();
  } catch (err) { console.warn('accent input handler error', err); }
});

accentPicker.addEventListener('mouseenter', () => {
  __stopRainbowAccent();
});
accentPicker.addEventListener('mouseleave', () => {
  if (!localStorage.getItem('accent')) __startRainbowAccent();
});

const __savedAccent = localStorage.getItem('accent');
if (__savedAccent) {
  __root.style.setProperty('--accent', __savedAccent);
  try { accentPicker.value = (__savedAccent.startsWith('#') ? __savedAccent : __savedAccent); } catch(e) {}
} else {
  __startRainbowAccent();
}

const resetAccentBtn = document.getElementById('resetAccentBtn');

resetAccentBtn.addEventListener('click', () => {
  localStorage.removeItem('accent');

  accentPicker.value = '';

  __startRainbowAccent();
});

})();
</script>
</body>
</html>
